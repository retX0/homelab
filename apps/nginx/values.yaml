nginx:
  image:
    registry: ghcr.io
    repository: retx0/bitnami-nginx
  env:
    TZ: Asia/Shanghai
  tls:
    enabled: true
    autoGenerated: false
    existingSecret: bitnami-nginx-tls
  extraVolumeMounts: # TODO: use template and configmap to generate conf
    - name: conf
      mountPath: /opt/bitnami/nginx/conf/server_blocks
    - name: cache
      mountPath: /var/cache/nginx
  extraVolumes:
    - name: conf
      persistentVolumeClaim:
        claimName: config
    - name: cache
      emptyDir:
        sizeLimit: "40Gi"
  # networkPolicy:
  #   enabled: true
  livenessProbe:
    enabled: false
  readinessProbe:
    enabled: false
  service:
    type: LoadBalancer
    annotations:
      # TODO: use dnsNames replace the hardcode domains
      external-dns.alpha.kubernetes.io/hostname: "ha.qos.cc,unifi.qos.cc,pve.qos.cc,emby.qos.cc,ilo.qos.cc"
  initContainers:
    - name: setup-conf
      image: busybox
      command: ['/bin/sh', '-c']
      args:
        - cd /tmp &&
          wget https://git.qos.cc/api/v1/repos/public/nginx/archive/main.zip &&
          unzip main.zip && cp -rf /tmp/nginx/* /opt/conf
      volumeMounts:
        - name: conf
          mountPath: /opt/conf
